version: 2.1

workflows:
  nightly:
    triggers:
      - schedule:
          cron: "0 0 * * *"
          filters:
            branches:
              only:
                - main
    jobs:
      - build
      - test-endorlabs-sca-scan:
          requires:
            - build

jobs:
  build:
    docker:
      - image: maven:3.6.3-jdk-11 # Modify this image as needed for your build steps
    steps:
      - checkout
      - run:
          name: "Build Your Project"
          command: mvn clean install # Replace with your actual build steps

  test-endorlabs-sca-scan:
    docker:
      - image: maven:3.6.3-jdk-11 # Modify this image as needed for your build tools
    environment:
      ENDORCTL_VERSION: "latest"
      ENDOR_NAMESPACE: "demo"
      DEBUG: "false"
    steps:
      - checkout
      - run:
          name: "Install endorctl"
          command: |
            apt-get update && apt-get install -y jq
            if [ "$ENDORCTL_VERSION" == "latest" ]; then
              echo "Downloading latest version of endorctl"
              VERSION=$(curl https://api.endorlabs.com/meta/version | jq -r '.Service.Version')
              ENDORCTL_SHA=$(curl https://api.endorlabs.com/meta/version | jq -r '.ClientChecksums.ARCH_TYPE_LINUX_AMD64')
              curl https://storage.googleapis.com/endorlabs/"$VERSION"/binaries/endorctl_"$VERSION"_linux_amd64 -o endorctl
              echo "$ENDORCTL_SHA  endorctl" | sha256sum -c
              if [ $? -ne 0 ]; then
                echo "Integrity check failed"
                exit 1
              fi
            else
              echo "Downloading version $ENDORCTL_VERSION of endorctl"
              curl https://storage.googleapis.com/endorlabs/"$ENDORCTL_VERSION"/binaries/endorctl_"$ENDORCTL_VERSION"_linux_amd64 -o endorctl
              # You need to set ENDORCTL_SHA here if you are using it in the integrity check
              chmod +x ./endorctl
            fi
      - run:
          name: "Endor Labs SCA Scan"
          command: |
            ./endorctl scan
