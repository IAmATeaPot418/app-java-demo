version: 2.1

workflows:
  version: 2
  nightly:
    triggers:
      - schedule:
          cron: "0 0 * * *"
          filters:
            branches:
              only:
                - main
    jobs:
      - build
      - test-endorlabs-sca-scan:
          requires:
            - build

jobs:
  build:
    docker:
      - image: maven:3.6.3-jdk-11 # Modify this image as needed for your build steps
    steps:
      - checkout
      - run:
          name: "Build Your Project"
          command: mvn clean install # Replace with your actual build steps

  test-endorlabs-sca-scan:
    docker:
      - image: maven:3.6.3-jdk-11 # Modify this image as needed for your build tools
    environment:
      ENDORCTL_VERSION: "latest"
      ENDOR_NAMESPACE: "demo"
      DEBUG: "false"
    steps:
      - checkout
      - run:
          name: "Install endorctl"
          command: |
            apt-get update && apt-get install -y jq
            if [ "$ENDORCTL_VERSION" == "latest" ]; then
              echo "Downloading latest version of endorctl"
              ENDORCTL_SHA=$(curl https://api.endorlabs.com/meta/version | jq -r '.ClientChecksums.ARCH_TYPE_LINUX_AMD64')
              VERSION=$(curl https://api.endorlabs.com/meta/version | jq -r '.Service.Version')
              curl https://storage.googleapis.com/endorlabs/"$VERSION"/binaries/endorctl_"$VERSION"_linux_amd64 -o endorctl
              echo "$ENDORCTL_SHA  endorctl" | sha256sum -c
              if [ $? -ne 0 ]; then
                echo "Integrity check failed"
                exit 1
              fi
            else
              echo "Downloading version $ENDORCTL_VERSION of endorctl"
              curl https://storage.googleapis.com/endorlabs/"$ENDORCTL_VERSION"/binaries/endorctl_"$ENDORCTL_VERSION"_linux_amd64 -o endorctl
              echo "$ENDORCTL_SHA  endorctl" | sha256sum -c
              if [ $? -ne 0 ]; then
                echo "Integrity check failed for the pinned version of endorctl. Please ensure the environment variable is set and re-run the job"
                exit 1
              fi
            fi
            chmod +x ./endorctl
      - run:
          name: "Endor Labs SCA Scan"
          command: |
            if [ "$DEBUG" == "true" ]; then
              export ENDOR_LOG_VERBOSE=true
              export ENDOR_LOG_LEVEL=debug
            fi
            if [ "$CIRCLE_BRANCH" == "$CIRCLE_DEFAULT_BRANCH" ]; then
              export ENDOR_AS_DEFAULT_BRANCH=true
              export ENDOR_SCAN_DETACHED_REF_NAME="$CIRCLE_BRANCH"
            else
              export ENDOR_CI_RUN=true
            fi
